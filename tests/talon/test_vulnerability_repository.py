"""
Comprehensive tests for VulnerabilityRepository.

Tests cover:
- CRUD operations
- Multi-tenant isolation
- Search and filtering
- Batch operations
- Edge cases and error handling
- Performance under load
"""

from decimal import Decimal
from uuid import uuid4

import pytest

from talon.models import Vulnerability
from talon.repositories.vulnerability_repository import VulnerabilityRepository


class TestVulnerabilityRepositoryBasicCRUD:
    """Test basic CRUD operations."""

    def test_init_requires_tenant_id(self, db_session):
        """Repository requires valid tenant_id."""
        with pytest.raises(ValueError, match="tenant_id is required"):
            VulnerabilityRepository(tenant_id="")

        with pytest.raises(ValueError, match="tenant_id is required"):
            VulnerabilityRepository(tenant_id="   ")

    def test_init_with_valid_tenant_id(self, db_session, tenant_id):
        """Repository initializes with valid tenant_id."""
        repo = VulnerabilityRepository(tenant_id=tenant_id)
        assert repo.tenant_id == tenant_id

    def test_find_by_cve_id_found(self, db_session, tenant_id, sample_vulnerability):
        """Find vulnerability by CVE ID when it exists."""
        repo = VulnerabilityRepository(tenant_id=tenant_id)

        result = repo.find_by_cve_id("CVE-2021-44228")

        assert result is not None
        assert result.cve_id == "CVE-2021-44228"
        assert result.severity == "CRITICAL"

    def test_find_by_cve_id_not_found(self, db_session, tenant_id):
        """Find vulnerability by CVE ID when it doesn't exist."""
        repo = VulnerabilityRepository(tenant_id=tenant_id)

        result = repo.find_by_cve_id("CVE-9999-99999")

        assert result is None

    def test_find_by_cve_id_case_insensitive(self, db_session, tenant_id, sample_vulnerability):
        """CVE ID lookup is case-insensitive."""
        repo = VulnerabilityRepository(tenant_id=tenant_id)

        result = repo.find_by_cve_id("cve-2021-44228")

        assert result is not None
        assert result.cve_id == "CVE-2021-44228"

    def test_find_by_cve_id_empty_string(self, db_session, tenant_id):
        """Find with empty CVE ID returns None."""
        repo = VulnerabilityRepository(tenant_id=tenant_id)

        result = repo.find_by_cve_id("")

        assert result is None

    def test_get_by_id_found(self, db_session, tenant_id, sample_vulnerability):
        """Get vulnerability by UUID when it exists."""
        repo = VulnerabilityRepository(tenant_id=tenant_id)

        result = repo.get_by_id(sample_vulnerability.id)

        assert result is not None
        assert result.id == sample_vulnerability.id

    def test_get_by_id_not_found(self, db_session, tenant_id):
        """Get vulnerability by UUID when it doesn't exist."""
        repo = VulnerabilityRepository(tenant_id=tenant_id)

        result = repo.get_by_id(uuid4())

        assert result is None

    def test_get_by_id_invalid_uuid(self, db_session, tenant_id):
        """Get with invalid UUID string returns None."""
        repo = VulnerabilityRepository(tenant_id=tenant_id)

        result = repo.get_by_id("not-a-uuid")

        assert result is None

    def test_create_vulnerability(self, db_session, tenant_id):
        """Create a new vulnerability."""
        repo = VulnerabilityRepository(tenant_id=tenant_id)

        vuln = Vulnerability(
            cve_id="CVE-2024-0001",
            description="Test vulnerability",
            severity="HIGH",
            cvss_score=Decimal("7.5"),
        )

        result = repo.create(vuln)
        repo.commit()

        assert result.id is not None
        assert result.cve_id == "CVE-2024-0001"

        # Verify in database
        found = repo.find_by_cve_id("CVE-2024-0001")
        assert found is not None

    def test_update_vulnerability(self, db_session, tenant_id, sample_vulnerability):
        """Update an existing vulnerability."""
        repo = VulnerabilityRepository(tenant_id=tenant_id)

        sample_vulnerability.description = "Updated description"
        sample_vulnerability.threat_score = Decimal("85.5")

        result = repo.update(sample_vulnerability)
        repo.commit()

        assert result.description == "Updated description"
        assert result.threat_score == Decimal("85.5")

    def test_delete_vulnerability(self, db_session, tenant_id, sample_vulnerability):
        """Delete a vulnerability by ID."""
        repo = VulnerabilityRepository(tenant_id=tenant_id)
        vuln_id = sample_vulnerability.id

        result = repo.delete(vuln_id)
        repo.commit()

        assert result is True
        assert repo.get_by_id(vuln_id) is None

    def test_delete_nonexistent_vulnerability(self, db_session, tenant_id):
        """Delete returns False for non-existent ID."""
        repo = VulnerabilityRepository(tenant_id=tenant_id)

        result = repo.delete(uuid4())

        assert result is False

    def test_exists_true(self, db_session, tenant_id, sample_vulnerability):
        """Exists returns True for existing vulnerability."""
        repo = VulnerabilityRepository(tenant_id=tenant_id)

        result = repo.exists(sample_vulnerability.id)

        assert result is True

    def test_exists_false(self, db_session, tenant_id):
        """Exists returns False for non-existent vulnerability."""
        repo = VulnerabilityRepository(tenant_id=tenant_id)

        result = repo.exists(uuid4())

        assert result is False


class TestVulnerabilityRepositoryFiltering:
    """Test filtering and search operations."""

    def test_find_by_severity(self, db_session, tenant_id, sample_vulnerabilities):
        """Find vulnerabilities by severity level."""
        repo = VulnerabilityRepository(tenant_id=tenant_id)

        critical = repo.find_by_severity("CRITICAL")
        high = repo.find_by_severity("HIGH")
        medium = repo.find_by_severity("MEDIUM")

        assert len(critical) == 2  # CVE-2023-0001 and CVE-2022-0001
        assert len(high) == 1
        assert len(medium) == 1

    def test_find_by_severity_enum(self, db_session, tenant_id, sample_vulnerabilities):
        """Find by severity using Severity enum."""
        from shared.types import Severity
        repo = VulnerabilityRepository(tenant_id=tenant_id)

        critical = repo.find_by_severity(Severity.CRITICAL)

        assert len(critical) == 2

    def test_find_by_min_cvss(self, db_session, tenant_id, sample_vulnerabilities):
        """Find vulnerabilities above CVSS threshold."""
        repo = VulnerabilityRepository(tenant_id=tenant_id)

        high_cvss = repo.find_by_min_cvss(7.0)
        critical_cvss = repo.find_by_min_cvss(9.0)

        assert len(high_cvss) == 3  # 9.8, 7.5, 9.1
        assert len(critical_cvss) == 2  # 9.8, 9.1

    def test_find_by_min_cvss_bounds(self, db_session, tenant_id, sample_vulnerabilities):
        """CVSS filter handles boundary values."""
        repo = VulnerabilityRepository(tenant_id=tenant_id)

        # Test value clamping
        all_vulns = repo.find_by_min_cvss(-1.0)  # Should clamp to 0
        none_vulns = repo.find_by_min_cvss(15.0)  # Should clamp to 10

        assert len(all_vulns) == 5
        assert len(none_vulns) == 0

    def test_find_by_package(self, db_session, tenant_id, sample_vulnerabilities):
        """Find vulnerabilities affecting a package."""
        repo = VulnerabilityRepository(tenant_id=tenant_id)

        results = repo.find_by_package("test-pkg")

        assert len(results) >= 1
        assert any(v.cve_id == "CVE-2023-0001" for v in results)

    def test_find_by_package_case_insensitive(self, db_session, tenant_id, sample_vulnerabilities):
        """Package search is case-insensitive."""
        repo = VulnerabilityRepository(tenant_id=tenant_id)

        results = repo.find_by_package("TEST-PKG")

        assert len(results) >= 1

    def test_find_recent(self, db_session, tenant_id, sample_vulnerabilities):
        """Find recently published vulnerabilities."""
        repo = VulnerabilityRepository(tenant_id=tenant_id)

        recent_7 = repo.find_recent(days=7)
        recent_30 = repo.find_recent(days=30)
        recent_90 = repo.find_recent(days=90)

        assert len(recent_7) == 1  # Only CVE-2023-0001 (5 days ago)
        assert len(recent_30) == 2  # CVE-2023-0001 and CVE-2023-0002
        assert len(recent_90) == 4  # All except CVE-2022-0001

    def test_search_by_query(self, db_session, tenant_id, sample_vulnerabilities):
        """Search vulnerabilities by text query."""
        repo = VulnerabilityRepository(tenant_id=tenant_id)

        results, total = repo.search(query="CVE-2023-0001")

        assert total == 1
        assert results[0].cve_id == "CVE-2023-0001"

    def test_search_by_description(self, db_session, tenant_id, sample_vulnerabilities):
        """Search vulnerabilities by description text."""
        repo = VulnerabilityRepository(tenant_id=tenant_id)

        results, total = repo.search(query="Critical")

        assert total >= 1

    def test_search_combined_filters(self, db_session, tenant_id, sample_vulnerabilities):
        """Search with multiple filters combined."""
        repo = VulnerabilityRepository(tenant_id=tenant_id)

        results, total = repo.search(
            query="vulnerability",
            severity="CRITICAL",
            min_cvss=9.0,
        )

        assert all(v.severity == "CRITICAL" for v in results)
        assert all(float(v.cvss_score) >= 9.0 for v in results)

    def test_search_pagination(self, db_session, tenant_id, sample_vulnerabilities):
        """Search handles pagination correctly."""
        repo = VulnerabilityRepository(tenant_id=tenant_id)

        page1, total = repo.search(query="", limit=2, offset=0)
        page2, _ = repo.search(query="", limit=2, offset=2)

        assert len(page1) == 2
        assert len(page2) == 2
        assert page1[0].id != page2[0].id  # Different results


class TestVulnerabilityRepositoryUpsert:
    """Test upsert operations."""

    def test_upsert_creates_new(self, db_session, tenant_id):
        """Upsert creates new vulnerability when not exists."""
        repo = VulnerabilityRepository(tenant_id=tenant_id)

        result = repo.upsert("CVE-2024-0001", {
            "description": "New vulnerability",
            "severity": "HIGH",
            "cvss_score": 7.5,
        })
        repo.commit()

        assert result.cve_id == "CVE-2024-0001"
        assert result.description == "New vulnerability"

    def test_upsert_updates_existing(self, db_session, tenant_id, sample_vulnerability):
        """Upsert updates existing vulnerability."""
        repo = VulnerabilityRepository(tenant_id=tenant_id)
        original_id = sample_vulnerability.id

        result = repo.upsert("CVE-2021-44228", {
            "description": "Updated description",
            "threat_score": 95.0,
        })
        repo.commit()

        assert result.id == original_id  # Same record
        assert result.description == "Updated description"
        assert result.threat_score == Decimal("95.0")

    def test_upsert_idempotent(self, db_session, tenant_id):
        """Multiple upserts with same data are idempotent."""
        repo = VulnerabilityRepository(tenant_id=tenant_id)

        data = {
            "description": "Test vulnerability",
            "severity": "MEDIUM",
            "cvss_score": 5.0,
        }

        result1 = repo.upsert("CVE-2024-0002", data)
        repo.commit()
        result2 = repo.upsert("CVE-2024-0002", data)
        repo.commit()

        assert result1.id == result2.id
        assert repo.count() == 1

    def test_bulk_upsert(self, db_session, tenant_id):
        """Bulk upsert multiple vulnerabilities."""
        repo = VulnerabilityRepository(tenant_id=tenant_id)

        vulns = [
            {"cve_id": "CVE-2024-0001", "severity": "HIGH", "cvss_score": 7.5},
            {"cve_id": "CVE-2024-0002", "severity": "MEDIUM", "cvss_score": 5.0},
            {"cve_id": "CVE-2024-0003", "severity": "LOW", "cvss_score": 2.5},
        ]

        created, updated = repo.bulk_upsert(vulns)

        assert created == 3
        assert updated == 0
        assert repo.count() == 3

    def test_bulk_upsert_mixed(self, db_session, tenant_id, sample_vulnerability):
        """Bulk upsert with mix of new and existing."""
        repo = VulnerabilityRepository(tenant_id=tenant_id)

        vulns = [
            {"cve_id": "CVE-2021-44228", "description": "Updated"},  # Existing
            {"cve_id": "CVE-2024-0001", "severity": "HIGH"},  # New
        ]

        created, updated = repo.bulk_upsert(vulns)

        assert created == 1
        assert updated == 1


class TestVulnerabilityRepositoryStatistics:
    """Test statistics and aggregation."""

    def test_get_severity_counts(self, db_session, tenant_id, sample_vulnerabilities):
        """Get vulnerability counts by severity."""
        repo = VulnerabilityRepository(tenant_id=tenant_id)

        counts = repo.get_severity_counts()

        assert counts.get("CRITICAL", 0) == 2
        assert counts.get("HIGH", 0) == 1
        assert counts.get("MEDIUM", 0) == 1
        assert counts.get("LOW", 0) == 1

    def test_get_statistics(self, db_session, tenant_id, sample_vulnerabilities):
        """Get comprehensive statistics."""
        repo = VulnerabilityRepository(tenant_id=tenant_id)

        stats = repo.get_statistics()

        assert stats["total"] == 5
        assert "severity_counts" in stats
        assert stats["average_cvss"] > 0
        assert stats["critical_count"] == 2

    def test_count(self, db_session, tenant_id, sample_vulnerabilities):
        """Count total vulnerabilities."""
        repo = VulnerabilityRepository(tenant_id=tenant_id)

        assert repo.count() == 5


class TestVulnerabilityRepositoryThreatScoring:
    """Test threat score operations."""

    def test_find_unscored(self, db_session, tenant_id, sample_vulnerabilities):
        """Find vulnerabilities without threat scores."""
        repo = VulnerabilityRepository(tenant_id=tenant_id)

        unscored = repo.find_unscored()

        assert len(unscored) == 5  # All unscored initially

    def test_update_threat_score(self, db_session, tenant_id, sample_vulnerability):
        """Update threat score for vulnerability."""
        repo = VulnerabilityRepository(tenant_id=tenant_id)

        result = repo.update_threat_score("CVE-2021-44228", 95.5)

        assert result is not None
        assert float(result.threat_score) == 95.5

    def test_update_threat_score_bounds(self, db_session, tenant_id, sample_vulnerability):
        """Threat score is clamped to valid range."""
        repo = VulnerabilityRepository(tenant_id=tenant_id)

        result = repo.update_threat_score("CVE-2021-44228", 150.0)

        assert float(result.threat_score) == 100.0

    def test_update_threat_score_not_found(self, db_session, tenant_id):
        """Update threat score returns None for missing CVE."""
        repo = VulnerabilityRepository(tenant_id=tenant_id)

        result = repo.update_threat_score("CVE-9999-99999", 50.0)

        assert result is None


class TestVulnerabilityRepositoryEdgeCases:
    """Test edge cases and error handling."""

    def test_malformed_cve_ids(self, db_session, tenant_id, malformed_cve_ids):
        """Handle malformed CVE IDs gracefully."""
        repo = VulnerabilityRepository(tenant_id=tenant_id)

        for bad_cve in malformed_cve_ids:
            result = repo.find_by_cve_id(bad_cve)
            assert result is None  # Should not raise

    def test_find_by_package_empty_string(self, db_session, tenant_id):
        """Find by empty package name returns empty list."""
        repo = VulnerabilityRepository(tenant_id=tenant_id)

        result = repo.find_by_package("")

        assert result == []

    def test_get_all_pagination_limits(self, db_session, tenant_id, sample_vulnerabilities):
        """Pagination respects limits."""
        repo = VulnerabilityRepository(tenant_id=tenant_id)

        # Request too many
        results = repo.get_all(limit=10000)
        assert len(results) <= 1000  # Capped at 1000

        # Request negative
        results = repo.get_all(limit=-5, offset=-10)
        assert len(results) >= 1  # Clamped to valid values

    def test_concurrent_upserts(self, db_session, tenant_id):
        """Handle concurrent upsert operations."""
        repo = VulnerabilityRepository(tenant_id=tenant_id)

        # Simulate concurrent upserts
        for i in range(10):
            repo.upsert("CVE-2024-CONCURRENT", {
                "description": f"Update {i}",
                "severity": "HIGH",
            })
        repo.commit()

        # Should still have only one record
        result = repo.find_by_cve_id("CVE-2024-CONCURRENT")
        assert result is not None
        assert result.description == "Update 9"

    def test_very_long_description(self, db_session, tenant_id):
        """Handle very long descriptions."""
        repo = VulnerabilityRepository(tenant_id=tenant_id)

        long_desc = "A" * 50000  # 50K characters
        result = repo.upsert("CVE-2024-LONG", {
            "description": long_desc,
            "severity": "LOW",
        })
        repo.commit()

        assert result is not None

    def test_special_characters_in_search(self, db_session, tenant_id, sample_vulnerability):
        """Search handles special characters safely."""
        repo = VulnerabilityRepository(tenant_id=tenant_id)

        # These should not cause SQL injection or errors
        searches = [
            "'; DROP TABLE vulnerabilities; --",
            "CVE-2021-44228%",
            "test\x00null",
            "test\nline",
        ]

        for query in searches:
            results, _ = repo.search(query=query)
            # Should not raise, may return 0 results


class TestVulnerabilityRepositoryOrdering:
    """Test ordering and sorting."""

    def test_get_all_default_order(self, db_session, tenant_id, sample_vulnerabilities):
        """Default ordering is by created_at descending."""
        repo = VulnerabilityRepository(tenant_id=tenant_id)

        results = repo.get_all()

        # Should be ordered by created_at desc
        assert len(results) > 0

    def test_get_all_custom_order(self, db_session, tenant_id, sample_vulnerabilities):
        """Custom ordering by specified column."""
        repo = VulnerabilityRepository(tenant_id=tenant_id)

        results_asc = repo.get_all(order_by="cvss_score", descending=False)
        results_desc = repo.get_all(order_by="cvss_score", descending=True)

        # First result should be different
        if results_asc and results_desc:
            assert results_asc[0].cvss_score <= results_desc[0].cvss_score

    def test_find_by_severity_ordered_by_cvss(
        self, db_session, tenant_id, sample_vulnerabilities
    ):
        """Severity results ordered by CVSS score."""
        repo = VulnerabilityRepository(tenant_id=tenant_id)

        results = repo.find_by_severity("CRITICAL")

        # Should be ordered by CVSS descending
        if len(results) > 1:
            assert results[0].cvss_score >= results[1].cvss_score
